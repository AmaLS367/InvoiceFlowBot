# Обзор системы

InvoiceFlowBot работает как Telegram бот, принимающий документы от пользователя и обрабатывающий их через слой OCR:

- Пользователь отправляет боту PDF или фото счета, загружая файл прямо в чат.
- `handlers/file.py` принимает вложение, валидирует формат и сохраняет временный файл.
- `services/invoice_service.py` координирует вызовы OCR через `ocr/engine/router.py` и конвертирует результаты в доменные сущности (`domain/invoices.py`).
- Слой OCR реализован через абстракцию провайдеров: интерфейс `OcrProvider` и реализацию `MindeeOcrProvider`. Модуль `ocr.engine.router` зависит только от интерфейса и вызывает текущий провайдер для распознавания счетов. В остальной части системы используется только функция `extract_invoice` из `ocr.engine.router`.
- Полученный черновик сохраняется в памяти состояния (`handlers/state.py`), а подтвержденные данные записываются в SQLite (`storage/db.py`).
- Телеграм интерфейс (`handlers/commands.py`, `handlers/callbacks.py`, `handlers/utils.py`) позволяет поправить поля, добавить комментарии и запросить историю.

## Движение данных

1. Пользователь отправляет PDF или изображение в бот.
2. `handlers/file.py` получает файл и вызывает `services/invoice_service.process_invoice_file()`.
3. Сервисный слой запускает `ocr/engine/router.py`, который использует OCR-провайдер (в настоящее время `MindeeOcrProvider`) для получения сырых данных распознавания из Mindee API.
4. `services/invoice_service.py` конвертирует результат OCR (`ExtractionResult`) в доменную сущность `Invoice`.
5. Черновик `Invoice` сохраняется в оперативной памяти (`handlers/state.py`), пользователь редактирует его через команды (`handlers/commands.py`) или callback-кнопки (`handlers/callbacks.py`).
6. Команда `/save` или callback сохранения вызывает `services/invoice_service.save_invoice()`, который сохраняет доменную сущность через `storage/db.py` в `data.sqlite`.
7. Команда `/invoices` и вспомогательные функции запрашивают `services/invoice_service.list_invoices()`, который получает доменные сущности из `storage/db.py` с фильтрацией по периоду и поставщику.

## Основные директории

- `bot.py` — точка входа Telegram бота и регистрация хендлеров.
- `config.py` — чтение `.env`, управление токенами, ключами Mindee и логированием.
- `domain/` — доменные сущности (Invoice, InvoiceHeader, InvoiceItem и т.д.), независимые от инфраструктуры.
- `services/` — сервисный слой, координирующий доменную логику, OCR-пайплайн и персистентность.
- `handlers/` — обработчики Telegram бота:
  - `file.py` — загрузка файлов и начальная обработка OCR
  - `commands.py` — обработчики текстовых команд (/show, /edit, /invoices и т.д.)
  - `callbacks.py` — обработчики callback-запросов для inline-кнопок (редактирование, сохранение, комментарии и т.д.)
  - `utils.py` — утилиты форматирования и построения клавиатур
  - `state.py` — управление глобальным состоянием пользовательских сессий
- `ocr/` — слой OCR с абстракцией провайдеров:
  - `providers/` — слой абстракции провайдеров:
    - `base.py` — интерфейс `OcrProvider`, определяющий контракт для OCR-провайдеров
    - `mindee_provider.py` — реализация `MindeeOcrProvider`, которая делегирует вызовы в Mindee API
  - `engine/router.py` — использует абстракцию провайдеров для вызова OCR-сервисов; остальная часть системы зависит только от `router.extract_invoice`
  - `mindee_client.py` — прямая интеграция с Mindee API (используется `MindeeOcrProvider`)
  - Общие утилиты и логирование
- `storage/db.py` — инициализация БД, сохранение инвойсов, выборки и комментирование.
- `tests/` — pytest покрытие для доменных сущностей, парсинга ответов Mindee, сервисного слоя, конвертации и работы с хранилищем.
