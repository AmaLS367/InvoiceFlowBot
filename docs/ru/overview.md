# Обзор системы

InvoiceFlowBot работает как Telegram бот, принимающий документы от пользователя и обрабатывающий их через слой OCR:

- Пользователь отправляет боту PDF или фото счета, загружая файл прямо в чат.
- `handlers/file.py` принимает вложение, валидирует формат и сохраняет временный файл.
- Модуль `ocr/extract.py` вызывает Mindee через `ocr/mindee_client.py`, а слой `ocr/engine` приводит ответ к внутренним типам.
- Полученный черновик сохраняется в памяти состояния (`handlers/state.py`), а подтвержденные данные записываются в SQLite (`storage/db.py`).
- Телеграм интерфейс (`handlers/commands.py` и `handlers/utils.py`) позволяет поправить поля, добавить комментарии и запросить историю.

## Движение данных

1. Пользователь отправляет PDF или изображение в бот.
2. Бот вызывает `ocr.extract` и Mindee client, получает сырые данные распознавания.
3. Слой `ocr/engine/router.py` и `ocr/engine/types.py` конвертирует ответ в нормализованный словарь и дополняет логи.
4. Черновик сохраняется в оперативном состоянии, пользователь редактирует его через команды и кнопки.
5. После подтверждения вызывается `storage.db.save_invoice`, который пишет счет, позиции и комментарии в `data.sqlite`.
6. Команда `/invoices` и вспомогательные функции используют `storage/db.py` для выборок по периоду и поставщику.

## Основные директории

- `bot.py` — точка входа Telegram бота и регистрацию хендлеров.
- `config.py` — чтение `.env`, управление токенами, ключами Mindee и логированием.
- `handlers/` — вся пользовательская логика: команды, прием файлов, глобальное состояние с черновиками.
- `ocr/` — интеграция с Mindee, маршрутизация моделей, утилиты для логирования.
- `storage/db.py` — инициализация БД, сохранение инвойсов, выборки и комментирование.
- `tests/` — pytest покрытие для парсинга ответов Mindee, конвертации и работы с хранилищем.

