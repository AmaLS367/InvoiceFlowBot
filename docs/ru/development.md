# Руководство по разработке

## Миграции базы данных

Схема базы данных управляется через Alembic поверх SQLite.

### Как поднимается схема

Во время запуска схема БД создается или обновляется через вызов `storage.db.init_db()`.  
Эта функция внутри выполняет команду:

```powershell
python -m alembic upgrade head
```

Любая точка входа, которая использует базу данных, должна один раз вызвать `init_db()` перед работой со стореджем.

### Запуск миграций локально

Чтобы локальная база была в актуальном состоянии, достаточно выполнить:

```powershell
python -m alembic upgrade head
```

Миграции применятся к файлу базы, путь к которому задан в `storage.db.DB_PATH`.

### Добавление новой миграции

Если вы меняете структуру таблиц, нужно добавить миграцию.

Рекомендуемый порядок действий:

1. Не править SQL в коде напрямую. Сначала создайте миграцию.

2. Сгенерировать заготовку миграции:

   ```powershell
   python -m alembic revision -m "описание_изменения"
   ```

3. Открыть файл из `alembic/versions/` и вручную описать SQL в функциях `upgrade` и `downgrade` под SQLite.

4. Применить миграцию:

   ```powershell
   python -m alembic upgrade head
   ```

Для SQLite автоматическая генерация схемы ограничена, поэтому миграции описываются вручную.

### Миграции и тесты

Тесты, которые используют базу данных, работают с теми же миграциями:

* В тесте можно подменить `storage.db.DB_PATH` на временный файл.

* Вызов `storage.db.init_db()` применит все миграции к этой временной базе.

Так тестовая схема всегда совпадает с боевой.

### Docker и миграции

При запуске бота в Docker миграции должны быть применены до старта процесса приложения.

Типичный паттерн — запускать:

```powershell
python -m alembic upgrade head
python bot.py
```

из entrypoint-скрипта.

### CI пайплайн

В GitHub Actions выполняются шаги:

1. Установка dev-зависимостей и пакета в editable-режиме:

   ```powershell
   python -m pip install -r requirements-dev.txt
   python -m pip install -e .
   ```

2. Применение миграций Alembic:

   ```powershell
   python -m alembic upgrade head
   ```

3. Запуск статических проверок и тестов:

   ```powershell
   python -m ruff check .
   python -m mypy domain services ocr storage
   python -m pytest
   ```

